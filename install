#!/bin/bash
# NOTE: Lowercase variables will be exported to a file

set -euo pipefail

# The below files will be forcefully removed when starting this script.
logFile="Arch-AI.log"

# Packages that will be installed on the system with pacstrap
# the only things you are allowed to remove here would be git
# removing other things might break the setup procedure
Pacstrap=(linux linux-firmware base base-devel networkmanager git go)
# Required packages to run this script
Reqs=(dosfstools fzf arch-install-scripts)

Fzf_Preview="fzf --border --reverse --height 50%"

usage="./$(basename "$0") [<flags>] -- Automatic Arch Linux install script

Flags:
    -h, --help    show this help text
    -s, --silent  don't show which commands are being run
    -v, --verbose enable showing the output of the commands"

read_arguments() {
  while (("$#")); do
    case "$1" in
    -v | --verbose)
      verbose=true
      ;;
    -s | --silent)
      silent=true
      ;;
    -h | --help)
      echo "$usage"
      exit 0
      ;;
    *)
      echo "Error: Unsupported flag $1" >&2
      echo "$usage"
      exit 1
      ;;
    esac
    shift
  done
}

# Obtain information about the system
# the script is running on
system_check() {
  local gpus gpu

  [ $EUID -ne 0 ] &&
    prompt "This script must be run as root" error &&
    exit 1

  prompt "Checking for UEFI" work
  if ! ls /sys/firmware/efi/efivars/ &>/dev/null; then
    prompt "Arch not booted into UEFI mode" error
    exit 1
  fi

  prompt "Identifying GPU drivers" work
  gpus=$(lspci | grep -e VGA -e 3D | tr '[:upper:]' '[:lower:]')

  # https://wiki.archlinux.org/index.php/Xorg#Installation
  # https://wiki.archlinux.org/index.php/Hardware_video_acceleration
  for gpu in $gpus; do
    case "$gpu" in
    # https://wiki.archlinux.org/index.php/Intel_graphics
    *"intel"*)
      prompt "Intel GPU found" green
      add_pkg mesa
      add_pkg vulkan-intel
      # HW acceleration
      add_pkg intel-media-driver
      add_pkg libva-intel-driver
      # 2D acceleration in Xorg
      add_pkg xf86-video-intel
      ;;
      # https://wiki.archlinux.org/index.php/AMDGPU
    *"amd"*)
      prompt "AMD GPU found" green
      add_pkg mesa
      add_pkg amdvlk
      # HW acceleration
      add_pkg libva-mesa-driver
      add_pkg mesa-vdpau
      # 2D acceleration in Xorg
      add_pkg xf86-video-amdgpu
      ;;
      # https://wiki.archlinux.org/index.php/NVIDIA
    *"nvidia"*)
      prompt "Nvidia GPU found" green
      add_pkg nvidia
      add_pkg nvidia-utils
      # HW acceleration
      add_pkg libva-mesa-driver
      add_pkg mesa-vdpau
      ;;
    esac
  done
}

# Installs missing requirements for this script (if any)
# and updates the mirrorlist if needed
installReqs() {
  prompt "Upading package database" work
  out pacman -Sy
  if ! grep -qi "generated by reflector" /etc/pacman.d/mirrorlist; then
    prompt "Installing reflector" work
    out pacman -S reflector --needed --noconfirm
    prompt "Generating new pacman mirrors, please be patient" work
    reflector --verbose --latest 15 --sort rate --save /etc/pacman.d/mirrorlist
  fi

  prompt "Installing additional packages if required" work
  out pacman -S "${Reqs[@]}" --needed --noconfirm
}

# Get username, hostname, password, locale
get_config() {
  # TODO fix how this is parsed
  locale_list="$(grep UTF-8 /etc/locale.gen | awk '{print $1}' | cut -c 2-)"

  while [[ -z ${locale:-} ]]; do
    prompt "Which locale would you like?" question
    locale=$(echo "$locale_list" | $Fzf_Preview)
  done

  while true; do
    iprompt "What hostname would you like:"
    hostname="$Reply"
    iprompt "What username would you like:"
    uName="$Reply"
    [[ -n $uName && -n $hostname ]] && break
    prompt "Username, hostname or the root password was left blank, try again" error
  done

  # Get user password
  iprompt "What password would you like for ${uName}:" silent
  # shellcheck disable=SC2034
  userPass="$Reply"
  echo

  # Get root password
  iprompt "What password would you like for the root user:" silent
  # shellcheck disable=SC2034
  rootPW="$Reply"
  echo
}

# Asks the user if they want microcode updates
# and installs it if that is the case
# https://wiki.archlinux.org/title/microcode
# TODO edit bootolader config
get_micro() {
  ! Ynprompt "Would you like to install microcode updates for your CPU?" && return

  prompt "Identifying the CPU drivers" work
  case "$(grep vendor /proc/cpuinfo | tr '[:upper:]' '[:lower:]')" in
  *"intel"*)
    prompt "Intel CPU found" green
    add_pkg intel-ucode
    ;;
    # TODO, no clue AMD processors contains "AMD" in vendor_id
  *"amd"*)
    prompt "AMD CPU found" green
    add_pkg amd-ucode
    ;;
  esac
}

# https://wiki.archlinux.org/index.php/Solid_state_drive#TRIM
# shellcheck disable=SC2034
get_misc() {
  Ynprompt "Would you like to install yay?" && installYAY=true
  Ynprompt "Would you like to auto-trim your mounted SSDs once a week?" &&
    enableSSDTRIM=true && add_pkg util-linux

  Ynprompt "Would you like to enable kernel parameters to allow for hibernation?" &&
    enableHibernation=true

  Ynprompt "Would you like to enable parallel and optimized compilation&compression for makepkg?" &&
    makepkgParallel=true
}

# Ask for some additional popular packages
get_pkgs() {
  prompt "Would you like to install any additional packages? (Use <Tab>)" question
  for choice in $(pacman -Slq | fzf -m --preview 'pacman -Si {1}' || true); do
    add_pkg "$choice"
  done
}

# Adds a package to be pacstrapped
add_pkg() {
  # Add package to list if not already there
  if [[ ${Pacstrap[*]} != *$1* ]]; then
    Pacstrap+=("$1")
  fi
}

# Asks which drive arch should be installed to
get_drive() {
  local drives numDrives choice
  local re='^[0-9]+$'
  lsblk
  echo
  drives=$(find /dev/sd*[a-z] | sort)

  numDrives=$(echo "$drives" | wc -w)

  echo "$drives" | awk '{print NR,$0}'
  while ! [[ ${choice:-} =~ $re ]] || [[ ${choice:-} -le 0 || ${choice:-} -gt $numDrives ]]; do
    iprompt "Which drive would you like to install Arch on [1-$numDrives]: "
    choice="$Reply"
  done

  # fs contains the base path to the drive
  # such as /dev/sda
  fs=$(echo "$drives" | sed -n "$choice"p)

  if [[ -z $fs ]]; then
    prompt "Something went wrong" error
    exit 1
  fi

  while ! [[ ${SwapSize:-} =~ $re ]]; do
    iprompt "How big should the swap partition be [GB]:"
    SwapSize="$Reply"
  done

  while ! [[ ${RootSize:-} =~ $re ]]; do
    prompt "Type 0 to fill the remaining space on the disk selected" note
    iprompt "How big should the root partition be [GB]:"
    RootSize="$Reply"
  done

  # Set formatting of the variables
  # so that fdisk can use them
  SwapSize="+${SwapSize}G"
  [[ $RootSize != 0 ]] && RootSize="+${RootSize}G"

  # Setup paths to the different
  # partitions on the hard drive
  bl="${fs}"1
  swap="${fs}"2
  root="${fs}"3
}

verify() {
  printf "Username: %s\nHostname: %s\nLocale: %s\n\n" "$uName" "$hostname" "$locale"
  printf "Installation drive: %s\nRoot partition: %s\nSwap partition: %s\n\n" \
    "$fs" "$RootSize" "$SwapSize"
  printf "Packages: %s\n" "${Pacstrap[*]}"
  read -rn 1 -p "Continue with install? (y/N)" && [[ ! $REPLY =~ ^[Yy]$ ]] &&
    prompt "Installation cancelled" error && exit
  echo
}

set_ntp() {
  out timedatectl set-ntp true # Enable Network Time Protocol (NTP) synchronization
}

# 1=bootloader, 2=swap, 3=root
format_fs() {
  while swapon --show | grep -q "$fs"; do
    prompt "$fs seems to have swap partition, trying to disable it" error
    swapoff "$(swapon --show | grep "$fs" | awk '{ print $1}')"
  done

  while df | grep -q "$fs"; do
    prompt "$fs seems to have some partion(s) mounted, trying to unmount" error
    ls "$fs"?* | xargs -n1 umount -l
    sleep 1
  done
  # Wipe drive
  out wipefs -af "$fs"

  prompt "Creating partitions" work
  (
    # GPT > MBR
    echo g

    mkpart "+512M"
    # Set partition type to 'EFI System'
    echo t
    echo 1

    mkpart "$SwapSize"
    # Set partition type to 'Linux Swap'
    echo t
    echo 2
    echo 19

    # Either fill the rest of the drive, or the chosen amount
    ([[ $RootSize -eq 0 ]] && mkpart) || mkpart "$RootSize"
    # Set partition type to 'Linux root (x86-64)'
    echo t
    echo 3
    echo 24
    echo w
  ) | out fdisk "$fs"

  prompt "Formatting partitions" work
  out mkfs.fat -F32 "$bl"
  out mkswap -L SWAP_PARTITION "$swap"
  out swapon "$swap"
  out mkfs.ext4 -F "$root"

  prompt "Setting partition labels" work
  out e2label "$root" ROOT_PARTITION

  prompt "Enabling fast_commit on ext4 filesystems" work
  out tune2fs -O fast_commit "$root"

  prompt "Mounting $root" work
  out mount "$root" /mnt

  prompt "Mounting $bl" work
  out mount --mkdir "$bl" /mnt/boot
}

# sequence for creating a new partition
# 1: size of partition (leave empty to fill)
mkpart() {
  echo n
  echo
  echo
  echo "${1:-}"
}

arch_install() {
  prompt "The script will now install and set up your system" green
  prompt "No further input will be needed" green
  sleep 2
  prompt "Pacstrapping packages" work
  pacstrap /mnt "${Pacstrap[@]}"
  prompt "Generating the fstab" work
  genfstab -U /mnt >/mnt/etc/fstab
}

# chroot into the new arch installation
jumpChroot() {
  # export all the current lowercase
  # variables into an info file
  (
    set -o posix
    set
  ) | grep -Ev '^([A-Z]|.$)' >/mnt/info

  cp setup /mnt/setup
  cp sharedfuncs /mnt/sharedfuncs
  chmod 554 /mnt/setup

  # Move files to the new arch installation
  mv "$logFile" /mnt/
  logFile="/$logFile"

  # Launch the setup script
  arch-chroot /mnt /bin/bash <<EOF
./setup
EOF
}

# Interactive prompt, reads the reply to the $Reply variable
# 1: message
# 2: set to enable silent mode
iprompt() {
  prompt "$1 " question true
  if [[ -n ${2:-} ]]; then
    read -rs Reply
  else
    read -r Reply
  fi
}

# Y/n prompt, returns 0 if answer is anything except n or N
# 1: message
Ynprompt() {
  prompt "$1 (Y/n) " question true
  read -rn 1
  if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo -e "\e[1Dn"
    return 1
  else
    echo -e "\e[1DY"
    return 0
  fi
}

main() {
  source sharedfuncs
  # Remove files from previous runs
  rm -f "$logFile"
  read_arguments "$@"
  system_check
  installReqs
  get_config
  get_micro
  get_misc
  get_pkgs
  get_drive
  verify
  set_ntp
  format_fs
  arch_install
  jumpChroot
  prompt "Arch Linux successfully installed" green
}

main "$@"

